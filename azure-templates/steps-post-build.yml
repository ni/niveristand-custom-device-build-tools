# IMPORTANT: Any changes made to this file may need to be duplicated in 
# ni/niveristand-scan-engine-ethercat-custom-device/custom-packaging.yml

parameters:
  - name: packages
    type: object
# Note: the following variables are defined in steps-prepare.yml:
  # CD.Nipkg.Path, CD.Repository, CD.LabVIEW.Version, CD.Release.Version,
  # CD.Release.Quarterly, CD.LabVIEW.ShortVersion, CD.BuildOutputPath,
  # CD.ArchivePath, CD.Architecture

steps:
  - ${{ each package in parameters.packages }}:
    - ${{ if ne(package.controlFileName, '') }}:
      - task: PowerShell@2
        displayName: Stage nipkg directory
        inputs:
          targetType: 'inline'
          script: |
            Write-Output "setting up nipkg directory..."
            If (Test-Path '$(CD.Nipkg.Path)')
            {
              Remove-Item -Path '$(CD.Nipkg.Path)' -Recurse -Force
            }
            New-Item -Path '$(CD.Nipkg.Path)' -ItemType 'Directory'
            New-Item -Path '$(CD.Nipkg.Path)' -Name 'control' -ItemType 'Directory'
            New-Item -Path '$(CD.Nipkg.Path)' -Name 'data' -ItemType 'Directory'
            New-Item -Path '$(CD.Nipkg.Path)' -Name 'debian-binary' -ItemType 'File'
            Set-Content '$(CD.Nipkg.Path)\debian-binary' '2.0\n'
            Copy-Item `
              -Path '$(CD.Repository)\${{ package.controlFileName }}' `
              -Destination '$(CD.Nipkg.Path)\control\control'
            `
            Write-Output "updating nipkg control version parameters..."
            $contents = (Get-Content -Path "$(CD.Nipkg.Path)\control\control") `
              -replace "{veristand_version}", "$(CD.LabVIEW.Version)" `
              -replace "{labview_version}", "$(CD.LabVIEW.Version)" `
              -replace "{nipkg_version}", "$(CD.Release.Version).$env:BUILDCOUNTER" `
              -replace "{display_version}", "$(CD.Release.Version)" `
              -replace "{quarterly_display_version}", "$(CD.Release.Quarterly)" `
              -replace "{labview_short_version}", "$(CD.LabVIEW.ShortVersion)" `
              -replace "{pkg_x86_bitness_suffix}", "$(CD.Nipkg.X86Suffix)"
            Write-Output $contents
            Set-Content -Value $contents -Path "$(CD.Nipkg.Path)\control\control"

      - ${{ each payloadMap in package.payloadMaps }}:
        - task: PowerShell@2
          displayName: Copying payload ${{ payloadMap.payloadLocation }} to install location
          inputs:
            targetType: 'inline'
            script: |
              New-Item -Path '$(CD.Nipkg.Path)\data\${{ payloadMap.installLocation }}' -ItemType 'Directory'
              Copy-Item `
                -Path '$(CD.Repository)\${{ payloadMap.payloadLocation }}\*' `
                -Destination '$(CD.Nipkg.Path)\data\${{ payloadMap.installLocation }}' `
                -Recurse

      - task: CmdLine@2
        displayName: Pack nipkg
        inputs:
          script: '"%PROGRAMFILES%\National Instruments\NI Package Manager\nipkg.exe" pack "$(CD.Nipkg.Path)" "$(CD.Nipkg.Path)"'

      - task: PowerShell@2
        displayName: Copy installer to build output location
        inputs:
          targetType: 'inline'
          script: |
            $installerPath = '$(CD.ArchivePath)\$(Build.BuildNumber)\$(CD.LabVIEW.Version)\installer'
            If (-not(Test-Path $installerPath))
            {
              New-Item -Path $installerPath -ItemType 'Directory'
            }
            Copy-Item `
              -Path '$(CD.Nipkg.Path)\*' `
              -Destination $installerPath `
              -Include *.nipkg `
              -Recurse
            Write-Output "Checking whether this is a release branch..."

  - task: PowerShell@2
    displayName: Copy built files to Archive location
    inputs:
      targetType: 'inline'
      script: |
        If (-not("$(CD.SourceBranch)" -match "release"))
        {
          $cleanedSourceBranch = "$(CD.SourceBranch)" -replace "\/", "_"
          Write-Output "Not a release branch, so appending branch name $cleanedSourceBranch to nipkg files..."
          $packages = Get-ChildItem `
            -Path "$(CD.ArchivePath)\$(Build.BuildNumber)\$(CD.LabVIEW.Version)\installer\*.nipkg"
          Foreach ($package in $packages)
          {
            If (-not("$package" -match "$cleanedSourceBranch.nipkg"))
            {
              Rename-Item -Path "$package" -NewName ("$package" -replace ".nipkg", "_$cleanedSourceBranch.nipkg")
            }
          }
        }

        If (-not(Test-Path "$(CD.ArchivePath)\$(Build.BuildNumber)\$(CD.LabVIEW.Version)\$(CD.Architecture)"))
        {
          New-Item `
            -Path "$(CD.ArchivePath)\$(Build.BuildNumber)\$(CD.LabVIEW.Version)\$(CD.Architecture)" `
            -ItemType 'Directory'
        }
        Copy-Item `
          -Path "$(CD.BuildOutputPath)\*" `
          -Destination "$(CD.ArchivePath)\$(Build.BuildNumber)\$(CD.LabVIEW.Version)\$(CD.Architecture)\" `
          -Recurse

  - task: PowerShell@2
    displayName: Create manifest file
    inputs:
      targetType: 'inline'
      script: |
        $installerPath = '$(CD.ArchivePath)\$(Build.BuildNumber)\$(CD.LabVIEW.Version)\installer'
        If ( ("$(CD.SourceBranch)" -match "release") -and (Test-Path $installerPath) )
        {
          Write-Output "Adding manifest file to release branch installer directory"
          $jsonFilePath = Join-Path $installerPath "manifest.json"
          $scmObject = [PSCustomObject]@{
            GIT_BRANCH = "$(CD.SourceBranch)"
            GIT_COMMIT = "$(Build.SourceVersion)"
            GIT_URL = "$(Build.Repository.Uri).git"
          }
          $outputObject = [PSCustomObject]@{
            scm = $scmObject
          }
          $jsonString = $outputObject | ConvertTo-Json
          Set-Content -Path $jsonFilePath -Value $jsonString
        }
        Else
        {
          Write-Output "No release branch packages built; skipping manifest file"
        }
