parameters:
  - name: lvVersionToBuild
    type: object
  - name: releaseVersion
    type: string
  - name: archiveLocation
    type: string
  - name: buildOutputLocation
    type: string
  - name: codegenVis
    type: object
  - name: submodules
    type: boolean

steps:
  - checkout: niveristand-custom-device-build-tools
    displayName: Check out NI VS Custom Device Build Tools repository

    # Checkout Self should be second - the checkout order doesn't matter in most cases, 
    # but we want the dev branch (self) to be checked out last so that it's used for PR builds in niveristand-custom-device-build-tools
  - checkout: self
    displayName: Check out repository to build with submodules
    submodules: ${{ parameters.submodules }}

  - task: PowerShell@2
    displayName: Configure Job-wide Variables for LabVIEW ${{ parameters.lvVersionToBuild.version }} ${{ parameters.lvVersionToBuild.bitness }}
    inputs:
      targetType: 'filePath'
      filePath: 'niveristand-custom-device-build-tools/azure-templates/powershell-scripts/define-build-variables.ps1'
      failOnStdErr: True
      arguments: >
        -lvVersion      '${{ parameters.lvVersionToBuild.version }}'
        -lvBitness      '${{ parameters.lvVersionToBuild.bitness }}'
        -archiveDir     '${{ parameters.archiveLocation }}'
        -outputDir      '${{ parameters.buildOutputLocation }}'
        -releaseVersion '${{ parameters.releaseVersion }}'
        -buildTools     'niveristand-custom-device-build-tools'



  - powershell: Write-Host '##vso[task.setvariable variable=lvCLICall]LabVIEWCLI -PortNumber 3363 -LabVIEWPath "$(lvPath)\LabVIEW.exe" -AdditionalOperationDirectory "%cd%\$(buildTools)\lv\operations"'
    displayName: Set LabVIEWCLI path

  - task: CmdLine@2
    displayName: Clear compiled cache for LabVIEW ${{ parameters.lvVersionToBuild.version }}
    inputs:
      script: |
        echo on
        $(lvCLICall) ^
          -OperationName "SecureRunVI" ^
          -VIPath "$(workspaceDirectory)\$(buildTools)\lv\operations\Utilities\ClearCache.vi" ^
          -LogFilePath "$(workspaceDirectory)\$(customDeviceRepoName)\lvClearCache.log"

  - ${{ each codegenVi in parameters.codegenVis }}:
    - ${{ if ne(codegenVi, '' )}}:
      - task: CmdLine@2
        displayName: Run codegen step ${{ codegenVi }}
        inputs:
          script: |
            echo on
            $(lvCLICall) ^
              -OperationName "SecureRunVI" ^
              -VIPath "$(workspaceDirectory)\$(customDeviceRepoName)\${{ codegenVi }}" ^
              -LogFilePath "$(workspaceDirectory)\$(customDeviceRepoName)\lvCodegen.log"